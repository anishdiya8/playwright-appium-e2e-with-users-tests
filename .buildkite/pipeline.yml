env:
  DEVICE_NAME: "iPhone 16 Pro"
  API_BASE_URL: "https://sdbnrxt339.execute-api.ap-southeast-2.amazonaws.com"
  X_API_KEY: "demo-key-123"

steps:
  - label: ":package: Upload prebuilt iOS app"
    key: "build-app"
    agents: { queue: "default" }
    commands:
      - '[[ -f "SimpleAPIAppanish.app.zip" ]] || { echo "ZIP missing in repo root"; ls -la; exit 1; }'
      - buildkite-agent artifact upload "SimpleAPIAppanish.app.zip"

  - wait

  - label: ":test_tube: E2E (Playwright + Appium)"
    key: "e2e"
    agents: { queue: "default" }
    concurrency: 1
    concurrency_group: "ios-simulator"
    timeout_in_minutes: 60
    commands:
      - node --version && npm --version
      - npm ci

      # bring app artifact into workspace
      - buildkite-agent artifact download "SimpleAPIAppanish.app.zip" .
      - unzip -q SimpleAPIAppanish.app.zip -d artifacts
      - export APP_PATH="$(/usr/bin/find artifacts -name 'SimpleAPIAppanish.app' -maxdepth 2 -print -quit)"
      - '[ -d "$APP_PATH" ] || { echo "ERROR: APP_PATH not found"; ls -R artifacts; exit 1; }'
      - echo "Using APP_PATH=$APP_PATH"

      # boot sim + start appium
      - bash scripts/sim-boot.sh "$DEVICE_NAME"
      - export SIM_NAME="$DEVICE_NAME"
      - bash scripts/start-appium.sh
      - bash scripts/wait-on-http.sh http://127.0.0.1:4723/status 45

      # hosted API checks
      - echo "Using API_BASE_URL=$API_BASE_URL"
      - env | sort | grep -E 'API_BASE_URL|DEVICE_NAME|X_API_KEY' || true
      - curl -fsS "$API_BASE_URL/healthz" || echo "No /healthz (that's fine)"

      # run tests (Playwright must emit junit-report.xml)
      - export DEVICE_NAME="$DEVICE_NAME" API_BASE_URL="$API_BASE_URL" X_API_KEY="$X_API_KEY"
      - npm run test:ci

      # stop appium
      - bash scripts/stop-appium.sh || { echo "Dumping appium.log due to stop failure"; tail -n +1 artifacts/appium.log || true; exit 1; }
    artifact_paths:
      - "playwright-report/**"
      - "junit-report.xml"
      - "artifacts/**"

  - wait

  - label: ":memo: Annotate JUnit"
    agents: { queue: "default" }
    plugins:
      - junit-annotate#v2.4.0:
          artifacts: "junit-report.xml"
          soft_fail: true
    commands:
      - echo "Annotating JUnit results"